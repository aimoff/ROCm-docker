# Choose which meta-package to be
ARG FLAVOR=complete


# base image
FROM debian:trixie AS base

# Register the ROCM package repository, and install rocm-language-runtime package
ARG ROCM_VERSION=7.1.1

RUN apt-get update \
  && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends apt-utils \
  && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends ca-certificates curl \
  && curl -sL https://repo.radeon.com/rocm/rocm.gpg.key >/etc/apt/keyrings/rocm.asc \
  && echo "deb [arch=amd64 signed-by=/etc/apt/keyrings/rocm.asc] https://repo.radeon.com/rocm/apt/$ROCM_VERSION noble main" >/etc/apt/sources.list.d/rocm.list \
  && DEBIAN_FRONTEND=noninteractive apt-get purge -y curl \
  && DEBIAN_FRONTEND=noninteractive apt-get --purge -y autoremove
COPY rocm-pin-600 /etc/apt/preferences.d/

RUN apt-get update \
  && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
  rocm-language-runtime \
  rocminfo


# Add rocm-openmp-sdk to openmp image
FROM base AS openmp-sdk

RUN DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
  rocm-openmp-sdk


# Add rocm-hip-runtime to base image
FROM base AS hip-runtime

RUN DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
  rocm-hip-runtime \
  && apt-mark auto rocminfo rocm-language-runtime


# Add rocm-hip-sdk to hip image
FROM hip-runtime AS hip-runtime-dev

RUN DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
  rocm-hip-runtime-dev \
  build-essential \
  && apt-mark auto rocm-hip-runtime


# Add rocm-hip-runtime to base image
FROM hip-runtime AS hip

RUN DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
  rocm-hip-libraries \
  && apt-mark auto rocm-hip-runtime


# Add rocm-hip-sdk to hip image
FROM hip AS hip-sdk

RUN DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
  rocm-hip-sdk \
  build-essential \
  && apt-mark auto rocm-hip-libraries


# Add rocm-ml-libraries to hip image
FROM hip AS ml
ARG GFX_ARCH

RUN apt-get update \
  && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
  rocm-ml-libraries \
  && apt-mark auto rocm-hip-libraries
RUN if [ -n "$GFX_ARCH" ]; then \
      DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
      miopen-hip-${GFX_ARCH}kdb || true; \
  fi


# Add rocm-ml-sdk to ml image
FROM ml AS ml-sdk

RUN DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
  rocm-ml-sdk \
  build-essential \
  && apt-mark auto rocm-ml-libraries


# Add rocm-opencl-runtime to base image
FROM base as opencl

RUN DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
  rocm-opencl-runtime \
  clinfo \
  && apt-mark auto rocm-language-runtime


# Add rocm-lib package to opencl image
FROM opencl AS opencl-sdk

RUN DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
  rocm-opencl-sdk \
  build-essential \
  && apt-mark auto rocm-opencl-runtime


# Add rocm-opencl-runtime to ml image
FROM ml AS complete

RUN DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
  rocm-opencl-runtime \
  clinfo \
  migraphx \
  mivisionx


# Add rocm-opencl-sdk to ml-sdk image
FROM ml-sdk AS complete-sdk

RUN DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
  rocm-opencl-sdk \
  clinfo \
  rocm-openmp-sdk \
  migraphx-dev \
  mivisionx-dev


# rocm-terminal
FROM ${FLAVOR} as runtime-term

# Add some packages for interactive shell
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
  sudo \
  vim-nox \
  less \
  python3 \
  python3-argcomplete \
  file \
  mediainfo \
  ffmpeg

# Grant members of 'sudo' group passwordless privileges
# Comment out to require sudo
COPY sudo-nopasswd /etc/sudoers.d/sudo-nopasswd

# This is meant to be used as an interactive developer container
# Create user $USER_NAME as member of sudo group
ARG UID
ARG RENDER_GID
ARG USER_NAME=rocm-user
RUN groupadd -g $RENDER_GID render; \
    if [ -n "$UID" ]; then \
        useradd -u "$UID" -G sudo,video,render --shell /bin/bash --create-home $USER_NAME; \
    else \
        useradd -G sudo,video,render --shell /bin/bash --create-home $USER_NAME; \
    fi

# Locale setting
ARG LANG=C.UTF-8
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
  locales
RUN sed -i "/$LANG/s/^# //" /etc/locale.gen && locale-gen

# cleanup
RUN apt-get clean \
  && rm -rf /var/lib/apt/lists/*

USER $USER_NAME
WORKDIR /home/$USER_NAME
ENV PATH "${PATH}:/opt/rocm/bin"

# Default to a login shell
CMD ["bash", "-l"]


# rocm-terminal with development libraries and tools
FROM ${FLAVOR} as dev-term

RUN DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
  sudo \
  vim-nox \
  less \
  file \
  git \
  cmake-curses-gui \
  python3-dev \
  python3-pip \
  python3-venv \
  python3-argcomplete \
  libplacebo-dev \
  rocm-developer-tools

# Install uv Python package and project manager
COPY --from=ghcr.io/astral-sh/uv:latest /uv /uvx /usr/local/bin/

# Grant members of 'sudo' group passwordless privileges
# Comment out to require sudo
COPY sudo-nopasswd /etc/sudoers.d/sudo-nopasswd

# This is meant to be used as an interactive developer container
# Create user $USER_NAME as member of sudo group
ARG UID
ARG RENDER_GID
ARG USER_NAME=rocm-user
RUN groupadd -g $RENDER_GID render; \
    if [ -n "$UID" ]; then \
        useradd -u "$UID" -G sudo,video,render --shell /bin/bash --create-home $USER_NAME; \
    else \
        useradd -G sudo,video,render --shell /bin/bash --create-home $USER_NAME; \
    fi

# Locale setting
ARG LANG=C.UTF-8
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
  locales
RUN sed -i "/$LANG/s/^# //" /etc/locale.gen && locale-gen

# cleanup
RUN apt-get clean \
  && rm -rf /var/lib/apt/lists/*

USER $USER_NAME
WORKDIR /home/$USER_NAME
ENV PATH "${PATH}:/opt/rocm/bin"

# Default to a login shell
CMD ["bash", "-l"]


# rocm-terminal to run X11 application
FROM ${FLAVOR} as x11-term

RUN DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
  sudo \
  vim-nox \
  less \
  file \
  mediainfo \
  ffmpeg

# Grant members of 'sudo' group passwordless privileges
# Comment out to require sudo
COPY sudo-nopasswd /etc/sudoers.d/sudo-nopasswd

# This is meant to be used as an interactive developer container
# Create user $USER_NAME as member of sudo group
ARG UID
ARG RENDER_GID
ARG USER_NAME=rocm-user
RUN groupadd -g $RENDER_GID render; \
    if [ -n "$UID" ]; then \
        useradd -u "$UID" -G sudo,video,render --shell /bin/bash --create-home $USER_NAME; \
    else \
        useradd -G sudo,video,render --shell /bin/bash --create-home $USER_NAME; \
    fi

# Modify to pre-install X11 related tools and user space drivers
# These packages are installed after render group has been added
# because a depending package would add render group with specific GID
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
  mesa-vulkan-drivers \
  vulkan-tools \
  libgulkan-utils \
  vainfo \
  xserver-xorg-video-amdgpu \
  x11-apps \
  dbus-x11 \
  mesa-utils \
  pulseaudio \
  fuse

# Locale setting
ARG LANG=C.UTF-8
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
  locales
RUN sed -i "/$LANG/s/^# //" /etc/locale.gen && locale-gen

# cleanup
RUN apt-get clean \
  && rm -rf /var/lib/apt/lists/*

# Make startup script to launch dbus for user session
COPY start-dbus.sh /usr/local/bin
RUN chmod +x /usr/local/bin/start-dbus.sh

# Append /opt/rocm/bin to the system PATH variable
USER $USER_NAME
WORKDIR /home/$USER_NAME
ENV PATH "${PATH}:/opt/rocm/bin"

# Default to a login shell
CMD ["/bin/sh", "/usr/local/bin/start-dbus.sh" ]
